<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>SI Metricstest</title>
  </head>
  <body>
    <div>
      <canvas id="smallimap" width="1200" height="600"></canvas>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
    <script src="js/suntimes.js"></script>
    <script src="js/renderframe.js"></script>
    <script src="js/color-0.4.1.js" type="text/javascript"></script>
    <script src="js/world.js" type="text/javascript"></script>
    <script src="js/smallimap.js" type="text/javascript"></script>
    <script src="js/some.js" type="text/javascript"></script>

    <script type="text/javascript">

      $(function() {
        // Enabled debug mode for console messages
        $.some.debug = true;
        var smallimap;

        // Configure metrics client
        var metricsClient = new $.some.SonicMetricsClient('SIMetricsClient', {
          serverUrl: 'http://www.small-improvements.com',//'http://localhost:8080',
          sourceId: 'SIMetricsClient',
          getEventsPath: 'queryActivitiesJSON',
          getServerTime: 'queryServertimeJSON',
          soundEnabled: false,
          useLocalStorage: false,
          useLastKeyOnRequests: false
        });

        // Callback for activity listeners
        function drawEventOnMap(listener, scheduledTimeout, event) {
          console.log("Scheduling activity on the map for listener" + listener.name + " in " + scheduledTimeout + " ms");

          window.setTimeout(function() {
            console.log("Creating event on the map for event " + event.label);
            smallimap.newEvent({
              latitude: event.latitude,
              longitude: event.longitude,
              color: '#ff00ff',
              weight: 1,
              length: 1000
            });
          }, scheduledTimeout);
        }

        function getClientsForMap() {
          $.getJSON('http://localhost:8080/queryClientsJSON?callback=?', function(data) {
            console.log("Received clients from SI");
            console.log(data);
          });
        }

        // Init map
        smallimap = $('#smallimap').smallimap().data('api');
        smallimap.run();

        window.smallimap = smallimap;

        // registerListener: (name, callback, sound='', subject='', category='', action='', label='')
        metricsClient.registerListener('activities', drawEventOnMap, '', 'siactivity');

        // Init metrics client
        metricsClient.init();

        // Start polling events
        metricsClient.login("dummy", "dummy");

        // Get clients and draw them on the map
        getClientsForMap();

      });

    </script>
  </body>
</html>
